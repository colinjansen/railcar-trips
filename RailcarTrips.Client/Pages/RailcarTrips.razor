@page "/"
@using System.Net.Http.Headers
@using System.Net.Http.Json
@inject HttpClient Http

<h1>Railcar Trips</h1>

<p>Upload an equipment events CSV file to process trips.</p>

<RailcarTripsFileUpload FileSelected="OnFileSelected"
                        ProcessRequested="ProcessFile"
                        CanProcess="@(_selectedFile is not null)"
                        IsProcessing="@_isProcessing" />

@if (!string.IsNullOrWhiteSpace(_statusMessage))
{
    <div class="alert alert-info mt-3">@_statusMessage</div>
}

<ProcessResultSummary Result="@_processResult" />
<TripsTable Trips="@_trips" SelectedTripId="@_selectedTripId" TripSelected="SelectTrip" />
<TripEventsTable TripEvents="@_selectedTripEvents" />

@code {
    private IBrowserFile? _selectedFile;
    private bool _isProcessing;
    private string? _statusMessage;
    private ProcessResultDto? _processResult;
    private List<TripDto> _trips = new();
    private int? _selectedTripId;
    private List<TripEventDto> _selectedTripEvents = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTripsAsync();
    }

    private void OnFileSelected(InputFileChangeEventArgs args)
    {
        _selectedFile = args.File;
        _statusMessage = null;
    }

    private async Task ProcessFile()
    {
        if (_selectedFile is null)
        {
            return;
        }

        _isProcessing = true;
        _statusMessage = "Processing...";
        _processResult = null;
        _selectedTripEvents.Clear();
        _selectedTripId = null;

        try
        {
            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(_selectedFile.OpenReadStream(maxAllowedSize: 10_000_000));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(_selectedFile.ContentType);
            content.Add(fileContent, "file", _selectedFile.Name);

            var response = await Http.PostAsync("api/railcartrips/process", content);
            if (!response.IsSuccessStatusCode)
            {
                _statusMessage = $"Processing failed: {response.ReasonPhrase}";
                return;
            }

            _processResult = await response.Content.ReadFromJsonAsync<ProcessResultDto>();
            _statusMessage = "Processing complete.";
            await LoadTripsAsync();
        }
        catch (Exception ex)
        {
            _statusMessage = $"Processing failed: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task LoadTripsAsync()
    {
        var trips = await Http.GetFromJsonAsync<List<TripDto>>("api/railcartrips");
        _trips = trips ?? new List<TripDto>();
    }

    private async Task SelectTrip(int tripId)
    {
        _selectedTripId = tripId;
        var events = await Http.GetFromJsonAsync<List<TripEventDto>>($"api/railcartrips/{tripId}/events");
        _selectedTripEvents = events ?? new List<TripEventDto>();
    }
}
